
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>9.3 调用栈 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-md-toc/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="4-disass.md" />
    
    
    <link rel="prev" href="2-debug-line.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    1 介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../2-preface/">
            
                <a href="../2-preface/">
            
                    
                    2 前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../3-terms/">
            
                <a href="../3-terms/">
            
                    
                    3 常用术语
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../4-basics/">
            
                <a href="../4-basics/">
            
                    
                    4 调试基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../4-basics/1-purposes.html">
            
                <a href="../4-basics/1-purposes.html">
            
                    
                    4.1 调试目的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../4-basics/2-dependencies.html">
            
                <a href="../4-basics/2-dependencies.html">
            
                    
                    4.2 调试依赖
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../4-basics/3-countertactics.html">
            
                <a href="../4-basics/3-countertactics.html">
            
                    
                    4.3 反调试技术
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../5-debugger-skeleton/">
            
                <a href="../5-debugger-skeleton/">
            
                    
                    5 走进调试器开发
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../5-debugger-skeleton/1-debugger_skeleton.html">
            
                <a href="../5-debugger-skeleton/1-debugger_skeleton.html">
            
                    
                    5.1 调试器概貌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../5-debugger-skeleton/2-debugger_demo.html">
            
                <a href="../5-debugger-skeleton/2-debugger_demo.html">
            
                    
                    5.2 调试器示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../6-develop-inst-debugger/">
            
                <a href="../6-develop-inst-debugger/">
            
                    
                    6 开发go指令级调试器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../6-develop-inst-debugger/1-process_start.html">
            
                <a href="../6-develop-inst-debugger/1-process_start.html">
            
                    
                    6.1 进程启动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../6-develop-inst-debugger/2-process_attach.html">
            
                <a href="../6-develop-inst-debugger/2-process_attach.html">
            
                    
                    6.2 进程attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../6-develop-inst-debugger/3-process_start_attach.html">
            
                <a href="../6-develop-inst-debugger/3-process_start_attach.html">
            
                    
                    6.3 启动&attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../6-develop-inst-debugger/4-debug-session.html">
            
                <a href="../6-develop-inst-debugger/4-debug-session.html">
            
                    
                    6.4 调试会话
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../6-develop-inst-debugger/5-disassemble.html">
            
                <a href="../6-develop-inst-debugger/5-disassemble.html">
            
                    
                    6.5 反汇编
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../6-develop-inst-debugger/6-breakpoint.html">
            
                <a href="../6-develop-inst-debugger/6-breakpoint.html">
            
                    
                    6.6 添加断点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../6-develop-inst-debugger/7-breakpoints.html">
            
                <a href="../6-develop-inst-debugger/7-breakpoints.html">
            
                    
                    6.7 列出断点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../6-develop-inst-debugger/8-clear.html">
            
                <a href="../6-develop-inst-debugger/8-clear.html">
            
                    
                    6.8 移除断点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="../6-develop-inst-debugger/9-clearall.html">
            
                <a href="../6-develop-inst-debugger/9-clearall.html">
            
                    
                    6.9 清空断点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="../6-develop-inst-debugger/10-step.html">
            
                <a href="../6-develop-inst-debugger/10-step.html">
            
                    
                    6.10 步进操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.11" data-path="../6-develop-inst-debugger/11-continue.html">
            
                <a href="../6-develop-inst-debugger/11-continue.html">
            
                    
                    6.11 运行到断点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.12" data-path="../6-develop-inst-debugger/12-pmem.html">
            
                <a href="../6-develop-inst-debugger/12-pmem.html">
            
                    
                    6.12 打印内存数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.13" data-path="../6-develop-inst-debugger/13-pregs.html">
            
                <a href="../6-develop-inst-debugger/13-pregs.html">
            
                    
                    6.13 打印寄存器数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.14" data-path="../6-develop-inst-debugger/20-bugfix-threads.md">
            
                <span>
            
                    
                    6.20 跟踪多线程程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.15" data-path="../6-develop-inst-debugger/21-refactor.md">
            
                <span>
            
                    
                    6.21 重构程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.16" data-path="../6-develop-inst-debugger/x-more.md">
            
                <span>
            
                    
                    6.x More...
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../7-headto-sym-debugger/">
            
                <a href="../7-headto-sym-debugger/">
            
                    
                    7 挺进符号级调试器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../7-headto-sym-debugger/1-elf.html">
            
                <a href="../7-headto-sym-debugger/1-elf.html">
            
                    
                    7.1 理解ELF文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../7-headto-sym-debugger/2-syms.html">
            
                <a href="../7-headto-sym-debugger/2-syms.html">
            
                    
                    7.2 符号&符号表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../7-headto-sym-debugger/3-syms-resolve.html">
            
                <a href="../7-headto-sym-debugger/3-syms-resolve.html">
            
                    
                    7.3 符号的解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../7-headto-sym-debugger/4-syms-reloc.html">
            
                <a href="../7-headto-sym-debugger/4-syms-reloc.html">
            
                    
                    7.4 重定位
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../7-headto-sym-debugger/5-loading.html">
            
                <a href="../7-headto-sym-debugger/5-loading.html">
            
                    
                    7.5 加载
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../7-headto-sym-debugger/6-gopkg-debug/">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/">
            
                    
                    7.6 go标准库debug/*
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.6.1" data-path="../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                    
                    7.6.1 debug/elf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.2" data-path="../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                    
                    7.6.2 debug/gosym
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.3" data-path="../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                    
                    7.6.3 debug/dwarf
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../7-headto-sym-debugger/7-headto-dwarf/">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/">
            
                    
                    7.7 挺进DWARF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../8-dwarf/">
            
                <a href="../8-dwarf/">
            
                    
                    8 调试信息标准: DWARF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../8-dwarf/1-history.html">
            
                <a href="../8-dwarf/1-history.html">
            
                    
                    8.1 发展历史
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../8-dwarf/2-structure.html">
            
                <a href="../8-dwarf/2-structure.html">
            
                    
                    8.2 DWARF结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../8-dwarf/3-die-readme.html">
            
                <a href="../8-dwarf/3-die-readme.html">
            
                    
                    8.3 调试信息条目：DIE
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.3.1" data-path="../8-dwarf/3-die-intro.html">
            
                <a href="../8-dwarf/3-die-intro.html">
            
                    
                    8.3.1 DIE介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.2" data-path="../8-dwarf/3-die-desc-datatype.html">
            
                <a href="../8-dwarf/3-die-desc-datatype.html">
            
                    
                    8.3.2 DIE描述数据和类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.3" data-path="../8-dwarf/3-die-desc-code.html">
            
                <a href="../8-dwarf/3-die-desc-code.html">
            
                    
                    8.3.3 DIE描述可执行代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.4" data-path="../8-dwarf/3-die-encoding.html">
            
                <a href="../8-dwarf/3-die-encoding.html">
            
                    
                    8.3.4 DIE数据编码
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../8-dwarf/4-other-readme.html">
            
                <a href="../8-dwarf/4-other-readme.html">
            
                    
                    8.4 其他调试数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.4.1" data-path="../8-dwarf/4-other-accelerated-access.html">
            
                <a href="../8-dwarf/4-other-accelerated-access.html">
            
                    
                    8.4.0 加速访问
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.2" data-path="../8-dwarf/4-other-lineno-table.html">
            
                <a href="../8-dwarf/4-other-lineno-table.html">
            
                    
                    8.4.1 行号表信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.3" data-path="../8-dwarf/4-other-macro-info.html">
            
                <a href="../8-dwarf/4-other-macro-info.html">
            
                    
                    8.4.2 宏信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.4" data-path="../8-dwarf/4-other-callframe-info.html">
            
                <a href="../8-dwarf/4-other-callframe-info.html">
            
                    
                    8.4.3 调用栈帧信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.5" data-path="../8-dwarf/4-other-varlen-data.html">
            
                <a href="../8-dwarf/4-other-varlen-data.html">
            
                    
                    8.4.4 变长数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.6" data-path="../8-dwarf/4-other-shrink-data.html">
            
                <a href="../8-dwarf/4-other-shrink-data.html">
            
                    
                    8.4.5 压缩DWARF数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.7" data-path="../8-dwarf/4-other-elf-sections.html">
            
                <a href="../8-dwarf/4-other-elf-sections.html">
            
                    
                    8.4.6 ELF Sections
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../8-dwarf/5-summary.html">
            
                <a href="../8-dwarf/5-summary.html">
            
                    
                    8.5 总结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="README.md">
            
                <span>
            
                    
                    9 开发go符号级调试器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="1-symtable & linetable.html">
            
                <a href="1-symtable & linetable.html">
            
                    
                    9.1 符号表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="2-debug-line.html">
            
                <a href="2-debug-line.html">
            
                    
                    9.2 行号表
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9.3" data-path="3-call-frame.html">
            
                <a href="3-call-frame.html">
            
                    
                    9.3 调用栈
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="4-disass.md">
            
                <span>
            
                    
                    9.4 反汇编
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="5-vars.md">
            
                <span>
            
                    
                    9.5 变量 & 类型系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="6-funcs.md">
            
                <span>
            
                    
                    9.6 函数 & 方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="7-goroutines.md">
            
                <span>
            
                    
                    9.7 协程 & 线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="x-gopkg.html">
            
                <a href="x-gopkg.html">
            
                    
                    9.x 标准库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="x-more.md">
            
                <span>
            
                    
                    9.x More...
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../10-thanks/">
            
                <a href="../10-thanks/">
            
                    
                    10 致谢
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../11-appendix/">
            
                <a href="../11-appendix/">
            
                    
                    11 附录
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../11-appendix/1-go-programme-start.html">
            
                <a href="../11-appendix/1-go-programme-start.html">
            
                    
                    11.1 go程序启动流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >9.3 调用栈</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h3 id="inspect-call-frame">Inspect Call Frame</h3>
<h4 id="purpose">Purpose</h4>
<p>Debuggers often need to view and modify the state of frame on the call frame stack. To be able to view or modify a frame that is not on the top of the call frame stack, the debugger must <em>virtually unwind</em> the stack of call frame util it finds the frame of interest. Virtually Unwind means it has the logic effect of returning from the current subroutine to its predecessor, but it can still <em>rewind</em> the stack back to the state it was in before it attempted to unwind it, just thinking <em>gdb commands like bt, frame $n, info frame</em>.</p>
<p>Dwarf v2 provides a way to describe the call frame information which is stored in section .debug_frame, and the basic idea of .debug_frame is to allow debuggers to figure out how to unwind frames, i.e., how to restore the previous frame from any instruction executing using the current frame.</p>
<p>For Example, consider the following assembly (with C code inline &#x2013; objdump -S):</p>
<p><img src="assets/clip_image003.png" alt="img"></p>
<p>For example, when we are inside testCall (i.e. from 4004cc onward), at every instruction, the .debug_frame information should allow us to restore all registers (such as rbp, rsp, eax etc.) to their previous status in the caller&#x2019;s frame (here the caller is main). <strong>This is done by keeping a table structure that keeps track of all the changes that happens with each register for every line of assembly.</strong></p>
<h4 id="cie--fde">CIE &amp; FDE</h4>
<p>As is mentioned above, we need keeping a table structure that keeps track of all the changes that happens with each register for every line of assembly. </p>
<h4 id="table-structure">Table Structure</h4>
<p>Dwarf supports virtual unwinding by defining an architecture independent basis for recording how procedures save and restore registers throughout their lifetimes. The basis must be augmented on some machines with specific information that is defined by either an architecture specific ABI authoring committee, a hardware vendor, or a compiler producer. The body defining a specific augmentation is referred to below as the augmenter.</p>
<p><img src="assets/clip_image004.png" alt="img"></p>
<p>In this table:</p>
<ul>
<li><p>LOC, it&#x2019;s the address of assembly (for example 4004cc), possible values are the address of each instruction.</p>
</li>
<li><p>CFA, it&#x2019;s the call frame address, which uses a register and an offset to calculate the CFA.</p>
</li>
<li><p>R0~RN: they&#x2019;re the registers that the particular architecture has, they record whether the registers&#x2019; values has been changed and how the value is changed.</p>
<p>Possible values are:</p>
<ul>
<li>Undefined(u): has no value in previous frame, it&#x2019;s not preserved by a callee.</li>
<li>Same(s): hasn&#x2019;t been modified from previous frame, it&#x2019;s not preserved by the callee, but the callee doesn&#x2019;t modify it.</li>
<li>Offset(N): previous value of this register is stored at the address CFA+N where CFA is the current CFA value and N is a signed offset.</li>
<li>Register(R): previous value of this register is stored at the register number R.</li>
<li>Architectural: the rule is defined externally to this specification by the augmenter.</li>
</ul>
</li>
</ul>
<p>In essence, the .debug_frame section and its corresponding cryptic tags are used to help the user construct such table.</p>
<h4 id="build-table">Build Table</h4>
<h5 id="example">Example</h5>
<p>Take following code as an example:</p>
<p><img src="assets/clip_image005.png" alt="img"></p>
<p>The .debug_frame can be used to generate following table:</p>
<p><img src="assets/clip_image006.png" alt="img"></p>
<h5 id="cie-helps-building-the-1st-row-in-cfi">CIE helps building the 1st row in CFI</h5>
<p>In section .debug_frame, each compilation unit has a single Common Information Entry (CIE), CIE describes how to built the first row in this table by the initial instructions included in this CIE, for example, <em>cie+13~cie+35</em> can be used for building the first row <em>foo [R7]+0 s u u u s s s s r1</em>.</p>
<p><img src="assets/clip_image007.png" alt="img"></p>
<p>A CIE holds information that is shared among many Frame Descriptions. There is at least one CIE in every non-empty .debug_frame section. Often, a compilation unit has a single CIE entry, which may contains a slice of FDE entries. A CIE has the following fields: length, CIE_id, version, augmentation, code_alignment_factor, data_alignment_factor, return_address_register, initial_instructions, padding.</p>
<p>This list shows how to construct the table structure. Read this in order:</p>
<ol>
<li>The CIE structure is 32 in length</li>
<li>This CIE has no augmentation (cie+9 = 0)</li>
<li>Code alignment factor is 4, so all location advancement needs /4</li>
<li>Data alignment factor is 4, so all offset advancement needs *4</li>
<li>The next one (cie+12) is the Register that holds the return address initially</li>
<li>The rest of the cie structure can either be all nop to pad to the correct length, or they can be definitions to set up the first row of the table. See that the above example sets up the 1st row correctly</li>
</ol>
<h5 id="fdes-help-building-following-rows-of-cfi">FDEs help building following rows of CFI</h5>
<p>Once the table structure is set up, FDE describe how each new row is constructed. There is an FDE per function per compilation unit. (Usually only 1 CIE for each CU).</p>
<p>Each CIE has a slice of FDEs, among which each FDE has a pointer to this CIE. These FDEs can be used for building the following rows in this table by the included instructions in this FDE.</p>
<p><img src="assets/clip_image008.png" alt="img"></p>
<p>A FDE holds information about a call frame, it has the following fields: length, CIE_pointer, initial_location, address_range, instructions.</p>
<p>The field <strong>initial_location</strong> refers to the address of the first assembly in this FDE, the <strong>address_range</strong> refers to the number of bytes of Dwarf DW<em>CFA</em>... instructions used for recreating the table row. When specifying a PC, we can use this expression <strong>(PC - fde.initial_location &lt; fde.address_range)</strong> to check whether this PC (instruction address) is within the range of this FDE. Actually we need to traverse the FDEs in the CIE to check which FDE covers the PC.</p>
<ol>
<li>Columns of new rows are initialized to the previous row first whenever a new row is added</li>
<li>FDE+16, advance_loc(1) means insert a new row in the table</li>
<li>FDE+17, def_cfa_offset means that the CFA column now has an offset at fsize/4 (4 being the data_alignment)</li>
<li>FDE+18, add new row</li>
<li>FDE+19, CFA_offset(8, 1), this means that register 8 is now stored at offset of 1*4 from CFA</li>
<li>FDE+38, register 8 is restored to the initial value (first row of the table)</li>
</ol>
<p>That&#x2019;s it! This basically covers .debug_frame.</p>
<p>Ref: <a href="http://ucla.jamesyxu.com/?p=231" target="_blank">http://ucla.jamesyxu.com/?p=231</a></p>
<h5 id="call-frame-instructions">Call Frame Instructions</h5>
<ul>
<li><p>DW_CFA_advance_loc(delta), advance delta * code_alignment_factor,</p>
</li>
<li><p>DW_CFA_def_cfa_register(R), takes a single unsigned LEB128 argument R representing a register number. The required action is to define the current CFA rule to use the provided register (but to keep the old offset).</p>
</li>
<li><p>DW_CFA_def_cfa_offset(N), takes a single unsigned LEB128 argument N representing an offset. The required action is to define the current CFA rule to use the provided offset  (but to keep the old register).</p>
</li>
<li><p>DW_CFA_offset(R, N), takes R as register number and N as offset to CFA, this create a offset(N) rule on register numbered R.</p>
</li>
<li><p>DW_CFA_restore(R), takes R as register number, it applies the rule assigned by CIE to R before to this register again in this new row.</p>
<blockquote>
<p>some of instructions mentioned above play an effect on following generated row, for example, DW_CFA_restore, etc.</p>
</blockquote>
</li>
</ul>
<p>According to this instructions stored in CIE or FDEs, we can know how to build the table structure.</p>
<h4 id="calc-returnaddress">Calc ReturnAddress</h4>
<p>How to calculate the ReturnAddress given any instruction in current frame?</p>
<h5 id="calculate-the-cfa-according-to-the-table-mentioned-above">Calculate the CFA according to the table mentioned above.</h5>
<p>CFA is specified by a register (golang uses RSP) and an offset, because Dwarf instruction DW<em>CFA</em>... cannot affect RSP&#x2019;s value, so when PC of instruction is specified, we can directly execute instructions in the single FDE covering this PC to get the CFA.</p>
<p>Remark: If we want get other registers&#x2019; values, we must execute all the predessesor FDEs&#x2019; instructions, then excute the FDE&#x2019;s instructions which covering this PC. Only by this, other registers&#x2019; values can be affected rightly.</p>
<h5 id="find-the-registered-which-holds-the-return-address">Find the registered which holds the return address</h5>
<p>Confirm which register holds the return address by <strong>CIE.return_address_register</strong>, this register maybe a virtual one (not an actual machine register), such as <strong>&quot;CFA - 8&quot;</strong> used in golang&#x2019;s CIE, which refers to a memory address, then we can use ptrace to peek the data  stored in this memory address, this is the return address.</p>
<p>Here is an golang CIE sample, DW_CFA_offset_extended: r16 (rip) at cfa-8, it defines that register numbered 16 is not an actual machine register, actually it points to a memory unit with address cfa-8.</p>
<p><img src="assets/clip_image009.png" alt="img"></p>
<blockquote>
<p>CFA is short for Canonical Frame Address or Caller Frame Address rather than ReturnAddress. Here&#x2019;s an issue which describes this point: <a href="https://github.com/derekparker/delve/issues/1181" target="_blank">https://github.com/derekparker/delve/issues/1181</a>.</p>
<p>Also, you can checkout this repo to validate this issue: <a href="https://github.com/hitzhangjie/golang-debugger" target="_blank">https://github.com/hitzhangjie/golang-debugger</a> at revision <9097961>.</9097961></p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="2-debug-line.html" class="navigation navigation-prev " aria-label="Previous page: 9.2 行号表">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="4-disass.md" class="navigation navigation-next " aria-label="Next page: 9.4 反汇编">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"9.3 调用栈","level":"1.9.3","depth":2,"next":{"title":"9.4 反汇编","level":"1.9.4","depth":2,"path":"9-develop-sym-debugger/4-disass.md","ref":"9-develop-sym-debugger/4-disass.md","articles":[]},"previous":{"title":"9.2 行号表","level":"1.9.2","depth":2,"path":"9-develop-sym-debugger/2-debug-line.md","ref":"9-develop-sym-debugger/2-debug-line.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["mermaid-cli","md-toc"],"pluginsConfig":{"intopic-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true,"label":{"en":"In This Article","zh":"本文目录"}},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"md-toc":{"label":"In this article","selector":".markdown-section h2","visible":true},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"mermaid-cli":{"chromeArgs":[],"chromeDir":"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome","mermaidArgs":""},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"9-develop-sym-debugger/3-call-frame.md","mtime":"2021-09-22T17:09:35.300Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-11-20T05:10:40.224Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/gumshoe.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

